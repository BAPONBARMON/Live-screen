<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<title>Live Browser View</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  margin:0;
  font-family:Arial;
  background:#0f172a;
  color:#fff;
  padding:12px;
}
.user{
  background:#1e293b;
  padding:10px;
  margin-bottom:8px;
  border-radius:6px;
}
button{
  padding:8px 12px;
  margin-top:6px;
  border:none;
  border-radius:5px;
  background:#22c55e;
}
video{
  width:100%;
  background:#000;
  margin-top:10px;
  display:none;
}
</style>
</head>

<body>

<h3>ðŸŸ¢ Online Users</h3>
<div id="me"></div>
<hr>
<div id="users"></div>

<video id="screen" autoplay playsinline></video>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, set, onValue, onDisconnect, remove } 
from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

/* ðŸ”¥ Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyCm4osVK6qMHItwvwcThrjJf3DRJFBDNN8",
  authDomain: "live-screen-share.firebaseapp.com",
  databaseURL: "https://live-screen-share-default-rtdb.firebaseio.com",
  projectId: "live-screen-share",
  storageBucket: "live-screen-share.firebasestorage.app",
  messagingSenderId: "249637860812",
  appId: "1:249637860812:web:f59fe87ee7417cddd8d969"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ðŸ‘¤ User */
const myId = "user_" + Math.floor(Math.random()*10000);
document.getElementById("me").innerText = "You: " + myId;

/* ONLINE */
const myRef = ref(db,"users/"+myId);
set(myRef,true);
onDisconnect(myRef).remove();

/* WebRTC */
let pc;
const video = document.getElementById("screen");

/* Show users */
onValue(ref(db,"users"), snap=>{
  const div=document.getElementById("users");
  div.innerHTML="";
  snap.forEach(c=>{
    if(c.key===myId) return;
    div.innerHTML+=`
      <div class="user">
        ${c.key}<br>
        <button onclick="request('${c.key}')">Request View</button>
      </div>`;
  });
});

/* Send request */
window.request=function(to){
  set(ref(db,"requests/"+to),{from:myId});
}

/* Receive request */
onValue(ref(db,"requests/"+myId), async snap=>{
  if(!snap.exists()) return;
  const from=snap.val().from;
  remove(ref(db,"requests/"+myId));

  if(confirm(from+" wants to view your browser. Accept?")){
    startShare(from);
  }
});

/* Start screen share */
async function startShare(viewer){
  pc = new RTCPeerConnection();
  pc.onicecandidate = e=>{
    if(e.candidate){
      set(ref(db,"candidates/"+viewer),e.candidate);
    }
  };

  const stream = 
    /Android/i.test(navigator.userAgent)
    ? await navigator.mediaDevices.getUserMedia({video:true})
    : await navigator.mediaDevices.getDisplayMedia({video:true});

  stream.getTracks().forEach(t=>pc.addTrack(t,stream));

  const offer=await pc.createOffer();
  await pc.setLocalDescription(offer);
  set(ref(db,"offers/"+viewer),offer);
}

/* Viewer receives offer */
onValue(ref(db,"offers/"+myId), async snap=>{
  if(!snap.exists()) return;
  remove(ref(db,"offers/"+myId));

  pc = new RTCPeerConnection();
  pc.ontrack = e=>{
    video.srcObject=e.streams[0];
    video.style.display="block";
  };
  pc.onicecandidate = e=>{
    if(e.candidate){
      set(ref(db,"candidates/"+snap.val().from),e.candidate);
    }
  };

  await pc.setRemoteDescription(snap.val());
  const answer=await pc.createAnswer();
  await pc.setLocalDescription(answer);
  set(ref(db,"answers/"+snap.val().from),answer);
});

/* Sharer receives answer */
onValue(ref(db,"answers/"+myId), async snap=>{
  if(!snap.exists()) return;
  await pc.setRemoteDescription(snap.val());
});

/* ICE */
onValue(ref(db,"candidates/"+myId), snap=>{
  if(snap.exists()) pc.addIceCandidate(snap.val());
});
</script>

</body>
</html>
